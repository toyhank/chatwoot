name: CI/CD Pipeline

on:
  push:
    branches: [ "main" ] # å½“ main åˆ†æ”¯æœ‰ä»£ç æäº¤æ—¶è§¦å‘
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘

env:
  REGISTRY: ghcr.io
  # é•œåƒåè‡ªåŠ¨ç”Ÿæˆä¸º: ghcr.io/ç”¨æˆ·å/ä»“åº“å (å…¨å°å†™)
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ä»»åŠ¡ä¸€ï¼šæ„å»ºå¹¶æ¨é€é•œåƒ
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # âœ…âœ…âœ… è¡¥ä¸Šè¿™ä¸€æ­¥ï¼è¿™æ˜¯è§£å†³æŠ¥é”™çš„å…³é”®
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=sha-
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            GIT_SHA=${{ github.sha }}

  # ä»»åŠ¡äºŒï¼šéƒ¨ç½²åˆ°æœåŠ¡å™¨
  deploy:
    needs: build-and-push # ç­‰å¾…æ„å»ºæˆåŠŸåæ‰æ‰§è¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: 22
          # å°† GitHub çš„ Commit SHA æ³¨å…¥åˆ°è„šæœ¬ä¸­
          envs: GITHUB_SHA
          script: |
            # --- 1. å˜é‡å‡†å¤‡ ---
            # å®šä¹‰é•œåƒåŸºç¡€å (å¿…é¡»å…¨å°å†™)
            # tr '[:upper:]' '[:lower:]' æ˜¯ä¸ºäº†é˜²æ­¢ç”¨æˆ·åæœ‰å¤§å†™å¯¼è‡´ Docker æŠ¥é”™
            IMAGE_BASE=$(echo "ghcr.io/${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
            
            # æˆªå– SHA å‰ 7 ä½ (ä¾‹å¦‚ 8a7d9f2)
            SHORT_SHA=$(echo $GITHUB_SHA | cut -c1-7)
            
            # æ‹¼æ¥å®Œæ•´çš„æ–°é•œåƒ Tag
            NEW_IMAGE="${IMAGE_BASE}:sha-${SHORT_SHA}"
            
            echo "ğŸš€ æ­£åœ¨éƒ¨ç½²ç‰ˆæœ¬: $NEW_IMAGE"
            
            # --- 2. è¿›å…¥é¡¹ç›®ç›®å½• ---
            # âš ï¸ è¯·ä¿®æ”¹ä¸ºä½ æœåŠ¡å™¨çš„å®é™…è·¯å¾„
            cd /root/chatwoot
            
            # --- 3. ä¿®æ”¹ docker-compose.yaml ---
            # ä½¿ç”¨ sed æŸ¥æ‰¾å¹¶æ›¿æ¢ image å­—æ®µ
            # é€»è¾‘ï¼šæ‰¾åˆ°ä»¥ "image: ghcr.io/..." å¼€å¤´çš„è¡Œï¼Œæ›¿æ¢ä¸ºæ–°ç‰ˆæœ¬
            sed -i "s|image: ${IMAGE_BASE}:.*|image: ${NEW_IMAGE}|g" docker-compose.yaml
            
            # æ‰“å°ä¸€ä¸‹ä¿®æ”¹ç»“æœç¡®è®¤
            echo "é…ç½®æ–‡ä»¶å·²æ›´æ–°ï¼š"
            grep "image:" docker-compose.yaml
            
            # --- 4. æ‹‰å–å¹¶é‡å¯ ---
            docker compose pull
            docker compose up -d
            
            # --- 5. æ¸…ç†æ—§é•œåƒ (é‡Šæ”¾ç£ç›˜ç©ºé—´) ---
            docker image prune -f
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"